<div class="row mb-3">
  <div class="col">
    <h2>Mapping CPL-Semester-MK</h2>
    <p class="text-muted">
      Pemetaan antara Capaian Pembelajaran Lulusan, Semester, dan Mata Kuliah
    </p>
  </div>
</div>

<style>
  /* CSS for fixed/frozen columns */
  .table-responsive {
    overflow-x: auto;
    position: relative;
  }

  .freeze-column-1 {
    position: sticky;
    background-color: white;
    left: 0;
    z-index: 2;
  }

  /* Add shadow effect to show depth */
  .freeze-column-1::after {
    content: "";
    position: absolute;
    top: 0;
    right: -5px;
    bottom: 0;
    width: 5px;
    background: linear-gradient(to right, rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0));
  }

  /* Style for the header cells */
  thead .freeze-column-1 {
    background-color: #cff4fc; /* Match bootstrap table-info class */
  }

  /* Custom tooltip styling */
  .custom-tooltip {
    position: absolute;
    background-color: #000;
    color: #fff;
    padding: 5px 10px;
    border-radius: 4px;
    font-size: 14px;
    z-index: 1000;
    max-width: 300px;
  }

  .cpl-code {
    cursor: help;
    font-weight: bold;
  }

  /* Style for MK codes */
  .mk-list {
    font-size: 0.9em;
    word-break: break-all;
  }
</style>

<div class="table-responsive">
  <table class="table table-bordered table-striped">
    <thead class="table-info">
      <tr>
        <th
          rowspan="2"
          class="align-middle freeze-column-1"
          style="min-width: 100px"
        >
          CPL
        </th>
        <th colspan="<%= semesters.length %>" class="text-center">Semester</th>
      </tr>
      <tr>
        <% if (semesters && semesters.length > 0) { %> <%
        semesters.forEach(semester => { %>
        <th class="text-center"><%= semester %></th>
        <% }) %> <% } %>
      </tr>
    </thead>
    <tbody class="table-group-divider">
      <% if (cpls && cpls.length > 0) { %> <% cpls.forEach((cpl) => { %>
      <tr>
        <td
          class="freeze-column-1 cpl-code"
          data-toggle="tooltip"
          title="<%= cpl.deskripsi %>"
          data-cpl-code="<%= cpl.kode_cpl %>"
          data-cpl-desc="<%= cpl.deskripsi %>"
        >
          <%= cpl.kode_cpl %>
        </td>
        <% semesters.forEach(semester => { %>
        <td class="text-center">
          <% const mks = mappingLookup[cpl.kode_cpl] &&
          mappingLookup[cpl.kode_cpl][semester] ?
          mappingLookup[cpl.kode_cpl][semester] : ''; %>
          <div class="mk-list"><%= mks %></div>
        </td>
        <% }) %>
      </tr>
      <% }) %> <% } else { %>
      <tr>
        <td colspan="<%= 1 + semesters.length %>" class="text-center">
          No CPLs available
        </td>
      </tr>
      <% } %>
    </tbody>
  </table>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Prevent default browser tooltips by moving title to data attribute
    document.querySelectorAll(".cpl-code").forEach((cell) => {
      const titleContent = cell.getAttribute("title");
      if (titleContent) {
        cell.setAttribute("data-tooltip-content", titleContent);
        cell.removeAttribute("title");
      }
    });

    // Initialize tooltips if Bootstrap's tooltip is available
    if (typeof $ !== "undefined" && $.fn.tooltip) {
      $('[data-toggle="tooltip"]').tooltip({
        container: "body",
        html: true,
      });
    } else {
      // Fallback for tooltip implementation if jQuery/Bootstrap is not available
      const cplCodes = document.querySelectorAll(".cpl-code");
      cplCodes.forEach((cell) => {
        const title =
          cell.getAttribute("data-tooltip-content") ||
          cell.getAttribute("data-cpl-desc");

        cell.addEventListener("mouseenter", function () {
          const tooltip = document.createElement("div");
          tooltip.className = "custom-tooltip";
          tooltip.innerHTML = title;

          document.body.appendChild(tooltip);

          const rect = cell.getBoundingClientRect();
          tooltip.style.top = `${rect.bottom + window.scrollY + 5}px`;
          tooltip.style.left = `${rect.left + window.scrollX}px`;

          cell.tooltip = tooltip;
        });

        cell.addEventListener("mouseleave", function () {
          if (cell.tooltip) {
            document.body.removeChild(cell.tooltip);
            cell.tooltip = null;
          }
        });
      });
    }
  });
</script>

<%- contentFor('title') %> CPL-Semester-MK Mapping
